# Snakemake file for ChIP-seq analysis
# Author: Elise van Bree
# Date: 15-08-2017

# work from a directory that contains the file hg19.chrom.sizes and the script bedGraphToBigWig.
# two directories above the working directory there should be a directory called bowtie, containing the indexed h919 genome, or change path in script to this directory (../../bowtie/).


SAMPLES = ["HL3LMBBXX_103162-001-007_CCGTCC_L005"]

rule all:
	input:
		# expand("03_bowtie/{sample}.sam", sample=SAMPLES),
		# expand("00_raw/{sample}_R1.fastq.gz", sample=SAMPLES),
		# expand("00_raw/{sample}_R2.fastq.gz", sample=SAMPLES)
		# expand("04_bam/{sample}.bam", sample=SAMPLES)
		# expand("04_bam/{sample}_sorted.bam", sample=SAMPLES)
		# expand("04_bam/{sample}_sorted_rmdup.bam", sample=SAMPLES)
		# expand("05_bedgraph/{sample}_sorted_rmdup.bedgraph", sample=SAMPLES)
		expand("06_bigwig/{sample}.bw", sample=SAMPLES)
	message: "ChIP-seq pipeline succesfully run."



rule trimmomaticPaired:
	input:
		forward = "00_raw/{sample}_R1.fastq",
		reverse = "00_raw/{sample}_R2.fastq"
	output:
		forward = "02_trimmed/{sample}_forward_trimmed.fastq",
		reverse = "02_trimmed/{sample}_reverse_trimmed.fastq",
		forwardUnpaired = "02_trimmed/{sample}_forward_Unpaired_trimmed.fastq",
		reverseUnpaired = "02_trimmed/{sample}_reverse_Unpaired_trimmed.fastq"
	message: "Trimming {input.forward} and {input.reverse} using Trimmomatic. Raw data will be gzipped after trimming is done. This will slow down the process."
	shell:
		"java -jar /zfs/datastore0/software/src/Trimmomatic-0.36/trimmomatic-0.36.jar PE -threads 8 -phred33 {input.forward} {input.reverse} {output.forward} {output.forwardUnpaired} {output.reverse} {output.reverseUnpaired} ILLUMINACLIP:/zfs/datastore0/software/src/Trimmomatic-0.36/adapters/TruSeq3-PE.fa:2:30:10 LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:40 ; gzip {input.forward} ; gzip {input.reverse}"



rule bowtie2:
	input:
		forward = "02_trimmed/{sample}_forward_trimmed.fastq",
		reverse = "02_trimmed/{sample}_reverse_trimmed.fastq",
		forwardUnpaired = "02_trimmed/{sample}_forward_Unpaired_trimmed.fastq",
		reverseUnpaired = "02_trimmed/{sample}_reverse_Unpaired_trimmed.fastq"
	output: "03_bowtie/{sample}.sam"
	message: "Mapping files {input.forward} {input.reverse} {input.forwardUnpaired} and {input.reverseUnpaired} using bowtie2. Trimmed files will be gzipped after mapping is done. This will slow down the process."
	shell:
		"bowtie2 --end-to-end --very-sensitive -p 16 -q --mm -x ../../bowtie/hg19 -1 {input.forward} -2 {input.reverse} -U {input.forwardUnpaired},{input.reverseUnpaired} -S {output} ; gzip {input.forward} ; gzip {input.reverse} ; gzip {input.forwardUnpaired} ; gzip {input.reverseUnpaired}"



rule bam:
	input:
		"03_bowtie/{sample}.sam"
	output:
		"04_bam/{sample}.bam"
	message: "Converting {input} to BAM. This will result in a smaller file. SAM file will be removed after BAM is generated."
	shell:
		"samtools view -b -@ 16 -o {output} {input} ; rm {input}"



rule sort:
	input:
		"04_bam/{sample}.bam"
	output:
		"04_bam/{sample}_sorted.bam"
	message: "Sorting {input} using samtools. This will result in a smaller file. Unsorted file will be removed after sorted file is generated."
	shell:
		"samtools sort -@ 16 -o {output} {input} ; rm {input}"



rule rmdup:
	input: 
		"04_bam/{sample}_sorted.bam"
	output:
		"04_bam/{sample}_sorted_rmdup.bam"
	message: "Removing duplicates in {input} using samtools"
	shell:
		"samtools rmdup {input} {output} ; rm {input}"



rule bedgraph:
	input: 
		"04_bam/{sample}_sorted_rmdup.bam"
	output:
		"05_bedgraph/{sample}_sorted_rmdup.bedgraph"
	message: "Making bedgraph of {input} using bedtools. Bam file will be saved, since it is necessary for peak calling"
	shell:
		"bedtools genomecov -bga -ibam {input} -g hg19.genome > {output}"

### make rule bigwig
rule bigwig:
	input: 
		"05_bedgraph/{sample}_sorted_rmdup.bedgraph"
	output:
		"06_bigwig/{sample}.bw"
	message: "Converting {input} to bigwig using bedGraphToBigWig from UCSC"
	shell:
		"bedGraphToBigWig {input} hg19.chrom.sizes {output}"


